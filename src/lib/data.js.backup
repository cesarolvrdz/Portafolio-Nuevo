import { supabase, handleSupabaseError, isSupabaseConfigured } from './supabase.js';

// Cache para optimizar rendimiento
const cache = new Map();
const CACHE_TTL = 5 * 60 * 1000; // 5 minutos

function getCacheKey(tableName, options = {}) {
  return `${tableName}_${JSON.stringify(options)}`;
}

function setCache(key, data) {
  cache.set(key, {
    data,
    timestamp: Date.now()
  });
}

function getCache(key) {
  const cached = cache.get(key);
  if (!cached) return null;
  
  const isExpired = Date.now() - cached.timestamp > CACHE_TTL;
  if (isExpired) {
    cache.delete(key);
    return null;
  }
  
  return cached.data;
}

// Datos de fallback
const fallbackData = {
  profile: {
    id: 1,
    name: 'César Valdez',
    email: 'cesolvrdz@gmail.com',
    phone: '(833) 107-7911',
    location: 'México',
    bio: 'Desarrollador Full Stack apasionado por crear soluciones web innovadoras y experiencias digitales excepcionales. Con experiencia en tecnologías modernas como React, Node.js, y bases de datos relacionales.',
    avatar_url: '/api/placeholder/400/400',
    website_url: 'https://cesolvrdz.dev',
    resume_url: '/cv.pdf',
    available_for_work: true,
    years_experience: 5,
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  },
  socialLinks: [
    {
      id: 1,
      platform: 'github',
      url: 'https://github.com/cesolvrdz',
      username: 'cesolvrdz',
      is_active: true,
      sort_order: 1
    },
    {
      id: 2,
      platform: 'linkedin',
      url: 'https://linkedin.com/in/cesolvrdz',
      username: 'cesolvrdz',
      is_active: true,
      sort_order: 2
    }
  ],
  projects: [
    {
      id: 1,
      title: 'E-commerce Platform',
      description: 'Plataforma de comercio electrónico desarrollada con React y Node.js',
      image_url: '/api/placeholder/600/400',
      tech_tags: ['React', 'Node.js', 'MongoDB', 'Stripe'],
      project_url: 'https://github.com/cesolvrdz',
      github_url: 'https://github.com/cesolvrdz',
      status: 'completed',
      is_featured: true
    },
    {
      id: 2,
      title: 'Task Management App',
      description: 'Aplicación de gestión de tareas con funciones de colaboración en tiempo real',
      image_url: '/api/placeholder/600/400',
      tech_tags: ['Vue.js', 'Firebase', 'Vuetify'],
      project_url: 'https://github.com/cesolvrdz',
      github_url: 'https://github.com/cesolvrdz',
      status: 'completed',
      is_featured: true
    }
  ],
  settings: {
    site_name: 'César Valdez - Desarrollador Full Stack',
    site_description: 'Portafolio profesional de César Valdez, desarrollador full stack especializado en tecnologías web modernas.',
    theme_color: '#3B82F6',
    show_hero: 'true',
    show_about: 'true',
    show_projects: 'true',
    show_contact: 'true'
  }
};

/**
 * Obtener información del perfil
 * @returns {Promise<Object>} Datos del perfil
 */
export async function getProfile() {
  if (!isSupabaseConfigured) {
    console.log('Using fallback profile data');
    return fallbackData.profile;
  }

  const cacheKey = getCacheKey('profile');
  const cached = getCache(cacheKey);
  if (cached) return cached;

  try {
    const { data, error } = await supabase
      .from('profile')
      .select('*')
      .single();

    if (error) throw error;
    
    setCache(cacheKey, data);
    return data;
  } catch (error) {
    console.warn('Error loading profile from database, using fallback:', error.message);
    return fallbackData.profile;
  }
}

/**
 * Obtener enlaces sociales activos
 * @returns {Promise<Array>} Lista de enlaces sociales
 */
export async function getSocialLinks() {
  if (!isSupabaseConfigured) {
    console.log('Using fallback social links data');
    return fallbackData.socialLinks;
  }

  const cacheKey = getCacheKey('social_links');
  const cached = getCache(cacheKey);
  if (cached) return cached;

  try {
    const { data, error } = await supabase
      .from('social_links')
      .select('*')
      .eq('is_active', true)
      .order('sort_order', { ascending: true });

    if (error) throw error;
    
    setCache(cacheKey, data);
    return data || [];
  } catch (error) {
    console.warn('Error loading social links from database, using fallback:', error.message);
    return fallbackData.socialLinks;
  }
}

/**
 * Obtener configuraciones del sitio
 * @param {string} group - Grupo específico de configuraciones
 * @returns {Promise<Array|Object>} Configuraciones del sitio
 */
export async function getSiteSettings(group = null) {
  const cacheKey = getCacheKey('site_settings', { group });
  const cached = getCache(cacheKey);
  if (cached) return cached;

  try {
    let query = supabase.from('site_settings').select('*');
    
    if (group) {
      query = query.eq('group', group);
    }

    const { data, error } = await query;
    if (error) throw error;

    // Convertir array a objeto para fácil acceso
    const settings = {};
    data.forEach(setting => {
      settings[setting.key] = setting.value;
    });

    setCache(cacheKey, group ? settings : data);
    return group ? settings : data;
  } catch (error) {
    handleSupabaseError(error);
  }
}

/**
 * Obtener proyectos
 * @param {boolean} featured - Solo proyectos destacados
 * @param {number} limit - Límite de proyectos a obtener
 * @returns {Promise<Array>} Lista de proyectos
 */
export async function getProjects(featured = false, limit = null) {
  const cacheKey = getCacheKey('projects', { featured, limit });
  const cached = getCache(cacheKey);
  if (cached) return cached;

  try {
    let query = supabase
      .from('projects')
      .select('*')
      .order('sort_order', { ascending: true });

    if (featured) {
      query = query.eq('is_featured', true);
    }

    if (limit) {
      query = query.limit(limit);
    }

    const { data, error } = await query;
    if (error) throw error;

    setCache(cacheKey, data);
    return data || [];
  } catch (error) {
    handleSupabaseError(error);
  }
}

/**
 * Obtener solo configuraciones públicas
 * @returns {Promise<Object>} Configuraciones públicas
 */
export async function getPublicSettings() {
  const cacheKey = getCacheKey('public_settings');
  const cached = getCache(cacheKey);
  if (cached) return cached;

  try {
    const { data, error } = await supabase
      .from('site_settings')
      .select('*')
      .eq('is_public', true);

    if (error) throw error;

    // Convertir a objeto para fácil acceso
    const settings = {};
    data.forEach(setting => {
      settings[setting.key] = setting.value;
    });

    setCache(cacheKey, settings);
    return settings;
  } catch (error) {
    handleSupabaseError(error);
  }
}

/**
 * Obtener configuraciones de apariencia para el tema
 * @returns {Promise<Object>} Configuraciones de tema
 */
export async function getThemeSettings() {
  return await getSiteSettings('appearance');
}

/**
 * Obtener configuraciones de SEO
 * @returns {Promise<Object>} Configuraciones SEO
 */
export async function getSeoSettings() {
  return await getSiteSettings('seo');
}

/**
 * Obtener configuraciones de contenido
 * @returns {Promise<Object>} Configuraciones de contenido
 */
export async function getContentSettings() {
  return await getSiteSettings('content');
}

/**
 * Obtener configuraciones de secciones (visibilidad)
 * @returns {Promise<Object>} Configuraciones de secciones
 */
export async function getSectionSettings() {
  return await getSiteSettings('sections');
}

/**
 * Obtener configuraciones de contacto
 * @returns {Promise<Object>} Configuraciones de contacto
 */
export async function getContactSettings() {
  return await getSiteSettings('contact');
}

/**
 * Limpiar caché (útil para desarrollo)
 */
export function clearCache() {
  cache.clear();
}
